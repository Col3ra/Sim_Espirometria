<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Espirometría — Centro de Simulación</title>
<style>
  :root{
    --bg:#f7fafb;
    --card:#ffffff;
    --ink:#0b2230;
    --muted:#5b6b76;
    --grid:#e6edf1;
    --accent:#005257; /* mismo espíritu que tu rgb(0,82,87) */
    --accent-2:#14b8a6;
    --danger:#c9363c;
    --warn:#b46a00;
    --ok:#1b8553;
    --radius:14px;
    --shadow:0 10px 30px rgba(0,0,0,.07);
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    line-height:1.4;
  }
  .app{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:16px; padding:16px; height:100%;
    box-sizing:border-box;
  }
  .panel{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; display:flex; flex-direction:column; gap:12px; min-height:0;
  }
  .charts{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; display:grid; grid-template-rows:auto 1fr; gap:12px; min-height:0;
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  h1{
    font-size:18px; margin:0; font-weight:700; letter-spacing:.2px;
  }
  .controls{ display:grid; gap:10px; }
  label{ font-weight:600; font-size:13px; color:var(--muted); }
  select, input[type="range"]{
    width:100%; padding:10px; border:1px solid var(--grid); border-radius:10px;
    background:#fff; font-size:14px;
  }
  .btns{ display:flex; gap:8px; flex-wrap:wrap; }
  button{
    border:0; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer;
    background:var(--accent); color:#fff;
  }
  button.secondary{ background:#e9f3f2; color:var(--accent); }
  button.ghost{ background:transparent; border:1px solid var(--grid); color:var(--ink); }
  button.warn{ background:var(--warn); color:#fff; }
  button.danger{ background:var(--danger); color:#fff; }
  button:disabled{ opacity:.6; cursor:not-allowed; }

  .metrics{
    display:grid; grid-template-columns:repeat(2,1fr); gap:8px;
  }
  .chip{
    border:1px solid var(--grid); border-radius:12px; padding:10px;
    display:flex; flex-direction:column; gap:2px; background:#fff;
  }
  .chip b{ font-size:16px; }
  .chip small{ color:var(--muted); font-weight:600; }

  .canvas-grid{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; min-height:0;
  }
  .plot{
    position:relative; background:#fff; border:1px solid var(--grid);
    border-radius:12px; padding:12px; min-height:260px; display:flex; flex-direction:column; gap:6px;
  }
  .plot h3{ margin:0; font-size:14px; color:var(--muted); font-weight:700; }
  .plot canvas{ width:100%; height:100%; flex:1; }
  .legend{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:12px; color:var(--muted);
  }
  .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; background:var(--accent); }
  .dot2{ background:var(--accent-2); }
  .hint{ font-size:12px; color:var(--muted); }
  .foot{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .spacer{ flex:1 }
  .hidden{ display:none !important; }

  /* responsive */
  @media (max-width: 980px){
    .app{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <!-- PANEL LATERAL -->
    <aside class="panel" id="panel">
      <header>
        <h1>Simulador de Espirometría</h1>
        <div class="btns">
          <button class="secondary" id="togglePanelBtn" title="Ocultar/mostrar parámetros">Ocultar</button>
        </div>
      </header>

      <div class="controls">
        <div>
          <label for="pattern">Patrón del paciente</label>
          <select id="pattern">
            <option value="normal">Normal</option>
            <option value="asma">Asma (obstructivo reversible)</option>
            <option value="epoc">EPOC (obstructivo)</option>
            <option value="enfisema">Enfisema</option>
            <option value="restrictivo">Restrictivo</option>
            <option value="mixto">Mixto (obstructivo + restrictivo)</option>
          </select>
        </div>

        <div>
          <label for="severity">Severidad (leve → severa)</label>
          <input id="severity" type="range" min="0" max="100" value="30" />
        </div>

        <div class="btns">
          <button id="startBtn">Inicio</button>
          <button id="pauseBtn" class="warn">Pausa</button>
          <button id="resetBtn" class="ghost">Reset</button>
        </div>
      </div>

      <div class="metrics" id="metrics">
        <div class="chip"><small>FVC (L)</small><b id="m_fvc">—</b></div>
        <div class="chip"><small>FEV1 (L)</small><b id="m_fev1">—</b></div>
        <div class="chip"><small>FEV1/FVC (%)</small><b id="m_ratio">—</b></div>
        <div class="chip"><small>PEF (L/s)</small><b id="m_pef">—</b></div>
        <div class="chip"><small>FEF25-75 (L/s)</small><b id="m_fef">—</b></div>
        <div class="chip"><small>Severidad</small><b id="m_sev">—</b></div>
      </div>

      <p class="hint">
        Consejos docentes: en **restrictivo** el trazado V-T alcanza rápido una meseta baja (FVC reducida)
        con relación FEV1/FVC normal/alta; en **obstructivo** el V-T sube lento (FEV1 bajo) y en F-V aparece
        concavidad espirada y PEF reducido.
      </p>

      <div class="btns">
        <button id="fsBtn" class="secondary">Pantalla completa</button>
      </div>
    </aside>

    <!-- ZONA DE GRAFICOS -->
    <section class="charts" id="charts">
      <div class="foot">
        <div class="legend">
          <span class="dot"></span> Ensayo actual
          <span class="dot dot2"></span> Curva teórica/objetivo
        </div>
        <div class="spacer"></div>
        <span class="hint">Intervalo: 0–6 s · Volumen 0–6 L · Flujo −2 a 12 L/s</span>
      </div>

      <div class="canvas-grid">
        <div class="plot">
          <h3>Volumen — Tiempo (V-T)</h3>
          <canvas id="vt"></canvas>
        </div>
        <div class="plot">
          <h3>Flujo — Volumen (F-V)</h3>
          <canvas id="fv"></canvas>
        </div>
      </div>
    </section>
  </div>

<script>
/* ===================== UTILIDADES ===================== */
const $ = (id)=>document.getElementById(id);
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
function lerp(a,b,t){ return a+(b-a)*t; }

/* Escalas para V-T y F-V */
const AXIS = {
  tMax: 6,     // segundos
  vMax: 6,     // litros
  flowMin: -2, // L/s (inspiración)
  flowMax: 12  // L/s (espiración pico)
};

/* ===================== PATRONES BASE =====================
   Cada patrón define FVC base, constante de vaciado 'k' (exp),
   PEF base y ajustes de forma para la concavidad de F-V.
=========================================================== */
const PATTERNS = {
  normal: {
    label: "Normal",
    FVC: 4.8,           // L
    k:   2.6,           // rapidez de llenado/espiración (↑ = sube rápido → FEV1 alto)
    PEF: 9.0,           // L/s
    concavity: 0.15,    // 0 = recto, >0 concavidad suave
    midFlow: 3.5        // FEF25-75 aprox
  },
  asma: {
    label: "Asma",
    FVC: 4.6,
    k:   1.2,
    PEF: 6.5,
    concavity: 0.45,
    midFlow: 2.2
  },
  epoc: {
    label: "EPOC",
    FVC: 4.2,
    k:   0.9,
    PEF: 5.5,
    concavity: 0.55,
    midFlow: 1.6
  },
  enfisema: {
    label: "Enfisema",
    FVC: 4.0,
    k:   0.75,
    PEF: 4.8,
    concavity: 0.65,
    midFlow: 1.3
  },
  restrictivo: {
    label: "Restrictivo",
    FVC: 2.8,
    k:   2.8,
    PEF: 8.0,
    concavity: 0.10,
    midFlow: 3.2
  },
  mixto: {
    label: "Mixto",
    FVC: 3.1,
    k:   1.0,
    PEF: 5.2,
    concavity: 0.50,
    midFlow: 1.9
  }
};

/* Ajuste por severidad [0..100] → escala de FVC y k */
function applySeverity(base, sev){
  // sev 0 = leve (casi base); sev 100 = muy severo
  const s = clamp(sev,0,100)/100;
  const FVC = base.FVC * lerp(1.0, (base===PATTERNS.restrictivo?0.45:0.6), s);
  const k   = base.k   * lerp(1.0, 0.35, s);
  const PEF = base.PEF * lerp(1.0, 0.5, s);
  const concavity = lerp(base.concavity, base.concavity*1.15 + 0.1*s, 0.8);
  const midFlow = base.midFlow * lerp(1.0, 0.55, s);
  return {FVC,k,PEF,concavity,midFlow};
}

/* Volumen en el tiempo (modelo monoexponencial) */
function volumeAt(t, FVC, k){
  t = clamp(t,0,AXIS.tMax);
  return FVC * (1 - Math.exp(-k * t / 1.0)); // t en s, k adimensional
}

/* Derivada aproximada para flujo (dV/dt) */
function flowAt(t, FVC, k){
  const dt=0.01;
  const v1 = volumeAt(t, FVC, k);
  const v0 = volumeAt(Math.max(0,t-dt), FVC, k);
  return (v1 - v0)/dt; // L/s
}

/* Curva teórica F-V con concavidad espirada */
function fvCurve(FVC, PEF, concavity){
  // Genera puntos (vol, flow) para espiración desde 0→FVC
  const pts = [];
  const N = 200;
  for(let i=0;i<=N;i++){
    const x = i/N;           // 0..1 de volumen espirado
    const vol = FVC * x;
    // Forma empírica: pico al inicio y decaimiento con concavidad controlada
    const decay = Math.exp(-3*x) * (1 - concavity*x) + (concavity*0.15*Math.pow(1-x,2));
    const flow = Math.max(0, PEF * clamp(decay, 0, 1));
    pts.push({vol,flow});
  }
  // Inspiración (opcional): trazo simple simétrico pequeño hacia flujo negativo
  for(let i=0;i<=N;i++){
    const x = i/N;
    const vol = FVC * (1 - x);
    const flow = - Math.min(2.0, 2.5*(1 - Math.cos(Math.PI*x))*0.5); // hasta ~-2 L/s
    pts.push({vol,flow});
  }
  return pts;
}

/* ===================== CANVAS & DIBUJO ===================== */
const vt = $("vt");
const fv = $("fv");
const dpr = window.devicePixelRatio||1;

function resizeCanvas(cnv){
  const rect = cnv.getBoundingClientRect();
  cnv.width = Math.floor(rect.width * dpr);
  cnv.height = Math.floor(rect.height * dpr);
}

function drawGrid(ctx, kind){
  const {width, height} = ctx.canvas;
  ctx.save();
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,width,height);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,width/dpr,height/dpr);
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
  ctx.lineWidth = 1;

  const gx = 8, gy = 6; // líneas guía
  const w = width/dpr, h = height/dpr;

  for(let i=0;i<=gx;i++){
    const x = (w*i/gx);
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  }
  for(let j=0;j<=gy;j++){
    const y = (h*j/gy);
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }

  // Ejes y etiquetas simples
  ctx.fillStyle = "#6b7a86"; ctx.font="12px system-ui";
  if(kind==="vt"){
    ctx.fillText("Tiempo (s)", w-80, h-8);
    ctx.fillText("Volumen (L)", 10, 14);
  } else {
    ctx.fillText("Volumen (L)", w-90, h-8);
    ctx.fillText("Flujo (L/s)", 10, 14);
  }
  ctx.restore();
}

/* Transformaciones a píxeles */
function vtToPx(ctx, t, v){
  const w = ctx.canvas.width/dpr, h = ctx.canvas.height/dpr;
  const x = (t/AXIS.tMax) * (w-24) + 18;
  const y = h-18 - (v/AXIS.vMax)*(h-36);
  return [x,y];
}
function fvToPx(ctx, vol, flow){
  const w = ctx.canvas.width/dpr, h = ctx.canvas.height/dpr;
  const x = (vol/AXIS.vMax) * (w-24) + 18;
  const y = h/2 - ((flow - (AXIS.flowMin+AXIS.flowMax)/2)/ (AXIS.flowMax-AXIS.flowMin))*(h-36);
  return [x,y];
}

/* ===================== ESTADO Y ANIMACIÓN ===================== */
let running=false, t=0;
let current={}, targetFV=[];

function computeMetrics(FVC,k,PEF,concavity, midFlow){
  const fev1 = volumeAt(1, FVC, k);
  const ratio = FVC>0 ? (fev1/FVC)*100 : 0;
  // Aprox FEF25-75: diferencia de volumen entre 25–75% en tiempo → derivada media
  const v25 = 0.25*FVC, v75 = 0.75*FVC;
  // Encontrar tiempos t25 y t75 por bisección simple del modelo
  function timeForVol(target){
    let lo=0, hi=AXIS.tMax;
    for(let i=0;i<30;i++){
      const mid=(lo+hi)/2;
      (volumeAt(mid,FVC,k)<target)? lo=mid : hi=mid;
    }
    return (lo+hi)/2;
  }
  const t25=timeForVol(v25), t75=timeForVol(v75);
  const fef2575 = (v75 - v25)/Math.max(0.2, (t75 - t25)); // L/s
  // PEF se toma del patrón ajustado (es pico instantáneo)
  return {FVC, FEV1:fev1, RATIO:ratio, PEF, FEF:fef2575};
}

function updateMetricsUI(m){
  const fmt = (x)=> (isFinite(x)? x.toFixed(2):"—");
  $("m_fvc").textContent = fmt(m.FVC);
  $("m_fev1").textContent = fmt(m.FEV1);
  $("m_ratio").textContent = isFinite(m.RATIO)? m.RATIO.toFixed(0):"—";
  $("m_pef").textContent = fmt(m.PEF);
  $("m_fef").textContent = fmt(m.FEF);
  $("m_sev").textContent = $("severity").value;
  // Colorear relación FEV1/FVC
  const ratioEl = $("m_ratio").parentElement;
  const r = m.RATIO;
  ratioEl.style.borderColor = (r<70? "var(--danger)" : r<75? "var(--warn)" : "var(--grid)");
}

function preparePattern(){
  const base = PATTERNS[$("pattern").value];
  const sev = +$("severity").value;
  current = applySeverity(base, sev);
  targetFV = fvCurve(current.FVC, current.PEF, current.concavity);
  const metrics = computeMetrics(current.FVC, current.k, current.PEF, current.concavity, current.midFlow);
  updateMetricsUI(metrics);
  t = 0;
  drawAll(0); // refresco estático
}

function drawVT(ctx, time){
  drawGrid(ctx,"vt");
  const steps = Math.floor( (time/AXIS.tMax) * 300 );
  ctx.save(); ctx.scale(dpr,dpr);
  // Curva objetivo tenue (teórica completa)
  ctx.beginPath();
  for(let i=0;i<=300;i++){
    const tt = AXIS.tMax*i/300;
    const v = volumeAt(tt, current.FVC, current.k);
    const [x,y] = vtToPx(ctx, tt, v);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim();
  ctx.lineWidth = 2; ctx.globalAlpha = .5; ctx.stroke(); ctx.globalAlpha=1;

  // Trazado actual hasta 'time'
  ctx.beginPath();
  for(let i=0;i<=steps;i++){
    const tt = AXIS.tMax*i/300;
    const v = volumeAt(tt, current.FVC, current.k);
    const [x,y] = vtToPx(ctx, tt, v);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  ctx.lineWidth = 2.2; ctx.stroke();

  // Cursor
  const vNow = volumeAt(time, current.FVC, current.k);
  const [cx,cy] = vtToPx(ctx, time, vNow);
  ctx.fillStyle = "#111"; ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2); ctx.fill();

  ctx.restore();
}

function drawFV(ctx, time){
  drawGrid(ctx,"fv");
  ctx.save(); ctx.scale(dpr,dpr);
  // Curva objetivo completa
  ctx.beginPath();
  targetFV.forEach((p,i)=>{
    const [x,y] = fvToPx(ctx, p.vol, p.flow);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim();
  ctx.lineWidth = 2; ctx.globalAlpha=.6; ctx.stroke(); ctx.globalAlpha=1;

  // Curva "en vivo": relacionamos tiempo con volumen espirado
  const volNow = volumeAt(time, current.FVC, current.k); // volumen alcanzado
  const N = 200;
  ctx.beginPath();
  for(let i=0;i<=N;i++){
    const x = i/N;
    const vol = current.FVC * x;
    if(vol>volNow) break;
    const decay = Math.exp(-3*x) * (1 - current.concavity*x) + (current.concavity*0.15*Math.pow(1-x,2));
    const flow = Math.max(0, current.PEF * clamp(decay,0,1));
    const [px,py] = fvToPx(ctx, vol, flow);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  ctx.lineWidth = 2.2; ctx.stroke();

  // Cursor en F-V
  const xFrac = clamp(volNow/current.FVC, 0, 1);
  const decay = Math.exp(-3*xFrac) * (1 - current.concavity*xFrac) + (current.concavity*0.15*Math.pow(1-xFrac,2));
  const flow = Math.max(0, current.PEF * clamp(decay,0,1));
  const [cx,cy] = fvToPx(ctx, volNow, flow);
  ctx.fillStyle="#111"; ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2); ctx.fill();

  ctx.restore();
}

function drawAll(time){
  const vtc = vt.getContext('2d'), fvc = fv.getContext('2d');
  resizeCanvas(vt); resizeCanvas(fv);
  drawVT(vtc, time);
  drawFV(fvc, time);
}

/* ===================== CONTROLES ===================== */
function loop(ts){
  if(!running) return;
  t += 0.016; // ~60 FPS
  if(t>AXIS.tMax){ running=false; }
  drawAll(t);
  if(running) requestAnimationFrame(loop);
}

$("startBtn").addEventListener("click", ()=>{
  if(!running){
    running=true;
    requestAnimationFrame(loop);
  }
});
$("pauseBtn").addEventListener("click", ()=>{ running=false; });
$("resetBtn").addEventListener("click", ()=>{ running=false; t=0; drawAll(0); });

$("pattern").addEventListener("change", preparePattern);
$("severity").addEventListener("input", preparePattern);

$("togglePanelBtn").addEventListener("click", ()=>{
  const panel = $("panel");
  const hidden = panel.classList.toggle("hidden");
  $("togglePanelBtn").textContent = hidden? "Mostrar" : "Ocultar";
});

$("fsBtn").addEventListener("click", ()=>{
  const el = $("app");
  if(!document.fullscreenElement){
    if(el.requestFullscreen) el.requestFullscreen();
  }else{
    if(document.exitFullscreen) document.exitFullscreen();
  }
});

/* Ajustes al entrar/salir de fullscreen: expandir gráficos */
document.addEventListener("fullscreenchange", ()=>{ drawAll(t); });

/* Inicialización */
window.addEventListener("resize", ()=> drawAll(t));
preparePattern();
</script>
</body>
</html>
